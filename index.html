<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#E10600" />
  <meta name="color-scheme" content="light dark" />

  <title>SCORE Store | Tienda Oficial</title>
  <meta name="description" content="Tienda oficial de merch SCORE. Fabricado en Tijuana por ÚNICO UNIFORMES. Ediciones limitadas por evento." />
  <meta name="robots" content="index,follow" />
  <link rel="canonical" href="https://scorestore.netlify.app/" />
  <link rel="manifest" href="/site.webmanifest" />

  <link rel="icon" href="/assets/icons-score.svg" type="image/svg+xml" />
  <link rel="icon" href="/assets/logo-score.png" type="image/png" />
  <link rel="apple-touch-icon" href="/assets/logo-score.png" />

  <script src="https://js.stripe.com/v3/"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Teko:wght@500;600;700&family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet" />

  <style>
    :root{
      --fontTitle: "Teko", sans-serif;
      --fontBody: "Inter", sans-serif;
      --red: #E10600;
      --carbon: #0b0f14;
      --sand: #f2f2f2;
      --green: #00C853;
      --pageBg: url("/assets/fondo-pagina-score.png");
      
      /* UX Tokens */
      --radius: 18px;
      --shadow: 0 20px 50px rgba(0,0,0,.18);
      --ease: cubic-bezier(0.23, 1, 0.32, 1);
    }

    *{box-sizing:border-box; -webkit-tap-highlight-color:transparent;}
    html,body{height:100%; margin:0;}
    
    body{
      font-family: var(--fontBody);
      color:#111;
      background-color: var(--sand);
      overflow-x:hidden;
      padding-bottom: 120px; /* Espacio para paybar móvil */
    }
    body.modalOpen{ overflow:hidden; }

    /* Fondo Fijo */
    body::after{
      content:""; position:fixed; inset:0;
      background-image: var(--pageBg);
      background-size: cover; background-position: center;
      opacity: .82; z-index:-6; pointer-events:none;
    }

    /* Topbar */
    .topbar{
      position:fixed; top:0; left:0; right:0; z-index:90;
      background: rgba(245,245,245,0.96);
      border-bottom: 3px solid var(--red);
      backdrop-filter: blur(12px);
    }
    .topInner{
      width:min(1200px, 94vw); margin:0 auto; height:76px;
      display:flex; align-items:center; justify-content:space-between;
    }
    .brand img{ height:56px; width:auto; display:block; }

    /* Botón Carrito */
    .cartTrigger{
      background: #0c0f14; color:#fff; border:none;
      height:54px; padding:0 20px;
      display:flex; align-items:center; gap:12px;
      font-family: var(--fontTitle); font-weight:700; font-size:24px;
      clip-path: polygon(10% 0, 100% 0, 100% 100%, 0% 100%);
      cursor:pointer; touch-action: manipulation;
    }
    .cartCount{
      background: var(--red); font-size: 12px; padding: 2px 6px;
      border-radius: 6px; font-weight:900;
    }

    /* Hero */
    .wrap{ width:min(1200px, 94vw); margin:0 auto; padding-top: 90px; }
    .hero{
      position:relative; border-radius: 18px; overflow:hidden;
      min-height: 520px; display:flex; align-items:center;
      background: #0b0f14; color:#fff;
      box-shadow: var(--shadow);
    }
    .heroBg{
      position:absolute; inset:0; background: url('/assets/hero.png') center/cover;
      opacity:.8; filter: contrast(1.1);
    }
    .heroContent{ position:relative; z-index:2; padding: 40px; max-width: 800px; }
    .hero h1{
      font-family: var(--fontTitle); font-size: clamp(48px, 9vw, 92px);
      line-height: .9; margin: 10px 0; text-transform: uppercase;
      text-shadow: 0 4px 20px rgba(0,0,0,0.6);
    }
    
    /* Botones CTA */
    .btn{
      border:none; cursor:pointer; font-weight: 900;
      text-transform: uppercase; border-radius: 14px;
      padding: 16px 24px; font-size: 14px; letter-spacing:.05em;
      transition: transform .1s var(--ease);
      display:inline-flex; align-items:center; justify-content:center;
      text-decoration:none; touch-action: manipulation;
    }
    .btn:active{ transform: scale(0.96); }
    .btn.primary{ background:#111; color:#fff; box-shadow: 0 8px 20px rgba(0,0,0,0.3); }

    /* Grilla de Ediciones */
    .editionsGrid{
      display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 16px; margin: 20px 0;
    }
    .editionCard{
      position:relative; border-radius: 18px; overflow:hidden;
      min-height: 260px; background: #0b0f14;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      display:flex; align-items:center; justify-content:center;
      cursor:pointer; transition: transform .2s var(--ease);
    }
    .editionCard:active{ transform: scale(0.98); }
    .editionBg{ position:absolute; inset:0; opacity:0.6; background-size:cover; }
    .editionLogo{ width: 80%; max-width: 240px; position:relative; z-index:2; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.5)); }

    /* Drawer Carrito */
    .drawer{
      position: fixed; top:0; right:0; bottom:0;
      width: min(450px, 90vw); background: #fff;
      transform: translateX(105%); transition: transform .35s var(--ease);
      z-index: 200; display:flex; flex-direction:column;
      box-shadow: -10px 0 40px rgba(0,0,0,0.3);
    }
    .drawer.active{ transform: translateX(0); }
    .dHead{ padding: 20px; border-bottom: 1px solid #eee; display:flex; justify-content:space-between; align-items:center; }
    .dBody{ flex:1; overflow-y:auto; padding: 20px; -webkit-overflow-scrolling: touch; }
    
    /* Inputs Móvil Friendly (16px para evitar zoom) */
    .input{
      width: 100%; height: 48px; border-radius: 12px;
      border: 1px solid #ccc; padding: 0 14px;
      font-size: 16px; font-weight: 600; font-family: var(--fontBody);
      margin-bottom: 10px; appearance: none;
    }
    .input:focus{ border-color: var(--red); outline:none; }

    /* Paybar Flotante */
    .paybar{
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(100px);
      width: min(1200px, 94vw); background: #fff; padding: 14px 20px;
      border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.25);
      display:flex; justify-content:space-between; align-items:center;
      z-index: 100; transition: transform .3s var(--ease);
    }
    .paybar.visible{ transform: translateX(-50%) translateY(0); }
    
    /* Utilería */
    .overlay{ position:fixed; inset:0; background:rgba(0,0,0,.6); opacity:0; pointer-events:none; z-index:150; transition:opacity .3s; }
    .overlay.active{ opacity:1; pointer-events:auto; }
    .toast{ 
      position:fixed; bottom: 100px; left:50%; transform:translateX(-50%); 
      background:#111; color:#fff; padding:12px 24px; border-radius:50px; 
      font-weight:700; opacity:0; pointer-events:none; transition:opacity .2s; z-index:300;
    }
    .toast.show{ opacity:1; }

    /* Modal Catálogo */
    .modal{
      position:fixed; inset:20px; background:#fff; border-radius:24px;
      z-index:250; display:flex; flex-direction:column;
      transform: scale(0.95); opacity:0; pointer-events:none; transition: .25s var(--ease);
    }
    .modal.active{ transform: scale(1); opacity:1; pointer-events:auto; }
    @media(min-width: 800px){ .modal{ inset: 50px 10%; } }

    .grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap:16px; padding:20px; overflow-y:auto; }
    .card{ border:1px solid #eee; border-radius:16px; padding:12px; text-align:center; }
    .card img{ width:100%; aspect-ratio: 1; object-fit:contain; margin-bottom:10px; }
  </style>
</head>
<body>

  <div class="overlay" id="overlay"></div>
  <div class="toast" id="toast">Agregado al carrito</div>

  <header class="topbar">
    <div class="topInner">
      <a class="brand" href="/"><img src="/assets/logo-score.png" alt="SCORE"></a>
      <button class="cartTrigger" id="openCart" aria-label="Carrito">
        SCORE STORE <span class="cartCount" id="cartCount">0</span>
      </button>
    </div>
  </header>

  <main class="wrap">
    <section class="hero">
      <div class="heroBg"></div>
      <div class="heroContent">
        <div style="background:var(--red); display:inline-block; padding:4px 12px; font-weight:800; transform:skew(-10deg);">OFICIAL MERCH</div>
        <h1>SCORE INTERNATIONAL</h1>
        <p style="font-size:18px; max-width:600px; margin-bottom:24px;">Fabricado en Tijuana por <b>ÚNICO UNIFORMES</b>. Productos auténticos de edición limitada.</p>
        <button class="btn primary" onclick="document.querySelector('.editionsGrid').scrollIntoView({behavior:'smooth'})">Ver Colecciones</button>
      </div>
    </section>

    <h2 style="font-family:var(--fontTitle); font-size:42px; margin:40px 0 20px;">EDICIONES</h2>
    
    <div class="editionsGrid">
      <div class="editionCard" data-open="catalog" data-section="EDICION_2025">
        <div class="editionBg" style="background-image:url('/assets/baja1000-texture.png')"></div>
        <img src="/assets/logo-baja1000.png" class="editionLogo" alt="Baja 1000">
      </div>
      
      <div class="editionCard" data-open="notify" data-edition="Baja 500">
        <div class="editionBg" style="background-color:#222;"></div>
        <img src="/assets/logo-baja500.png" class="editionLogo" alt="Baja 500">
        <div style="position:absolute; bottom:20px; color:#fff; font-weight:800;">PRÓXIMAMENTE</div>
      </div>
    </div>
  </main>

  <div class="modal" id="modalCatalog">
    <div class="dHead">
      <h3 style="margin:0; font-family:var(--fontTitle); font-size:28px;">CATÁLOGO</h3>
      <button class="btn" id="closeCatalog">X</button>
    </div>
    <div class="grid" id="catalogGrid"></div>
  </div>

  <aside class="drawer" id="drawer">
    <div class="dHead">
      <h3 style="margin:0; font-family:var(--fontTitle); font-size:28px;">TU EQUIPO</h3>
      <button class="btn" id="closeDrawer">Cerrar</button>
    </div>
    <div class="dBody" id="cartBody"></div>
    <div style="padding:20px; background:#f9f9f9; border-top:1px solid #eee;">
      <div style="display:flex; justify-content:space-between; font-weight:900; font-size:18px; margin-bottom:10px;">
        <span>Total Estimado:</span>
        <span id="cartTotal">$0 MXN</span>
      </div>
      
      <p style="font-size:12px; color:#666;">Selecciona entrega:</p>
      <select class="input" id="shipMethod">
        <option value="">-- Elige opción --</option>
        <option value="pickup">Recoger en Fábrica (Tijuana) - Gratis</option>
        <option value="tj">Envío Local (Tijuana) - $80 MXN</option>
        <option value="mx">Envío Nacional (México) - Cotizar</option>
      </select>
      
      <div id="shipForm" style="display:none; margin-top:10px;">
        <input class="input" id="shipPostal" type="tel" placeholder="Código Postal (5 dígitos)" maxlength="5">
        <input class="input" id="shipState" placeholder="Estado (ej. BC)" maxlength="3">
        <input class="input" id="shipCity" placeholder="Ciudad">
        <input class="input" id="shipAddress" placeholder="Calle y número">
        <input class="input" id="shipName" placeholder="Nombre completo">
      </div>

      <button class="btn primary" id="payBtn" style="width:100%; margin-top:12px;" disabled>IR A PAGAR</button>
    </div>
  </aside>

  <div class="paybar" id="paybar">
    <div>
      <div style="font-size:10px; font-weight:800; color:#666;">TOTAL A PAGAR</div>
      <div style="font-size:20px; font-weight:900;" id="pbTotal">$0 MXN</div>
    </div>
    <button class="btn primary" id="pbBtn">Ver Carrito</button>
  </div>

  <script>
    // --- CONFIGURACIÓN DE PAGO ---
    const STRIPE_PK = "pk_live_51Se6fsGUCnsKfgrBdpVBcTbXG99reZVkx8cpzMlJxr0EtUfuJAq0Qe3igAiQYmKhMn0HewZI5SGRcnKqAdTigpqB00fVsfpMYh"; 

    // Configuración General
    const STORE = { api: "/.netlify/functions", catalog: "/data/catalog.json" };
    let state = { cart: [], shipping: { method: null, cost: 0, valid: false } };

    // DOM Elements
    const $ = (id) => document.getElementById(id);
    const els = {
      drawer: $('drawer'), modal: $('modalCatalog'), overlay: $('overlay'),
      cartCount: $('cartCount'), cartBody: $('cartBody'), cartTotal: $('cartTotal'),
      payBtn: $('payBtn'), pbTotal: $('pbTotal'), paybar: $('paybar'),
      shipMethod: $('shipMethod'), shipForm: $('shipForm')
    };

    // --- LÓGICA CORE ---

    // 1. Cargar Catálogo
    async function loadProducts(sectionId) {
      try {
        const res = await fetch(STORE.catalog);
        const data = await res.json();
        const products = data.products.filter(p => p.sectionId === sectionId);
        renderGrid(products);
        openModal();
      } catch (e) { alert("Error cargando catálogo"); }
    }

    function renderGrid(items) {
      $('catalogGrid').innerHTML = items.map(p => `
        <div class="card">
          <img src="${p.img}" loading="lazy" alt="${p.name}">
          <div style="font-weight:700; font-size:14px; line-height:1.2;">${p.name}</div>
          <div style="font-weight:900; margin:6px 0;">$${p.baseMXN}</div>
          <select id="sz_${p.id}" class="input" style="height:36px; padding:0 8px; font-size:14px;">
            ${(p.sizes||['Unitalla']).map(s=>`<option>${s}</option>`)}
          </select>
          <button class="btn primary" style="width:100%; padding:10px;" 
            onclick="addToCart('${p.id}', '${p.name}', ${p.baseMXN}, '${p.img}')">
            AGREGAR
          </button>
        </div>
      `).join('');
    }

    // 2. Carrito
    function addToCart(id, name, price, img) {
      const size = $(`sz_${id}`).value;
      const key = `${id}-${size}`;
      const exists = state.cart.find(i => i.key === key);
      
      if(exists) exists.qty++;
      else state.cart.push({ key, id, name, price, img, size, qty: 1 });
      
      updateCartUI();
      showToast("Agregado al carrito");
      closeModal(); 
      openDrawer();
    }

    function updateCartUI() {
      const totalItems = state.cart.reduce((a, b) => a + b.qty, 0);
      const subtotal = state.cart.reduce((a, b) => a + (b.price * b.qty), 0);
      const total = subtotal + (state.shipping.cost || 0);

      els.cartCount.innerText = totalItems;
      els.cartTotal.innerText = `$${total} MXN`;
      els.pbTotal.innerText = `$${total} MXN`;

      // Render items
      els.cartBody.innerHTML = state.cart.map((i, idx) => `
        <div style="display:flex; gap:10px; margin-bottom:12px; background:#f5f5f5; padding:8px; border-radius:12px;">
          <img src="${i.img}" style="width:50px; height:50px; object-fit:cover; border-radius:8px;">
          <div style="flex:1;">
            <div style="font-weight:700; font-size:13px;">${i.name}</div>
            <div style="font-size:12px; color:#666;">Talla: ${i.size} | $${i.price}</div>
          </div>
          <div style="display:flex; flex-direction:column; align-items:flex-end; justify-content:space-between;">
            <button onclick="removeItem(${idx})" style="border:none; background:none; color:red; font-weight:900;">×</button>
            <div style="font-weight:900;">x${i.qty}</div>
          </div>
        </div>
      `).join('') || '<div style="text-align:center; padding:40px; opacity:0.5;">Carrito Vacío</div>';

      // Paybar visibility
      if(totalItems > 0) els.paybar.classList.add('visible');
      else els.paybar.classList.remove('visible');

      validateCheckout();
      localStorage.setItem('score_cart', JSON.stringify(state.cart));
    }

    function removeItem(idx) {
      state.cart.splice(idx, 1);
      updateCartUI();
    }

    // 3. Checkout y Envíos
    els.shipMethod.addEventListener('change', (e) => {
      const method = e.target.value;
      state.shipping.method = method;
      
      if(method === 'pickup') { state.shipping.cost = 0; els.shipForm.style.display = 'none'; }
      else if(method === 'tj') { state.shipping.cost = 80; els.shipForm.style.display = 'none'; }
      else if(method === 'mx') { state.shipping.cost = 0; els.shipForm.style.display = 'block'; }
      else { state.shipping.cost = 0; els.shipForm.style.display = 'none'; }
      
      updateCartUI();
    });

    function validateCheckout() {
      const hasItems = state.cart.length > 0;
      const method = state.shipping.method;
      let isValid = false;

      if(hasItems && method) {
        if(method === 'mx') {
          // Validar campos mínimos para envíos nacionales
          if($('shipPostal').value.length === 5 && $('shipState').value.length > 1 && $('shipAddress').value.length > 5) isValid = true;
        } else {
          isValid = true;
        }
      }
      els.payBtn.disabled = !isValid;
    }
    
    // Listeners de inputs para validar en tiempo real
    ['shipPostal', 'shipState', 'shipAddress', 'shipName'].forEach(id => {
      $(id).addEventListener('input', validateCheckout);
    });

    els.payBtn.addEventListener('click', async () => {
      els.payBtn.innerText = "PROCESANDO...";
      els.payBtn.disabled = true;

      try {
        const payload = {
          items: state.cart,
          shipping: {
            mode: state.shipping.method,
            to: {
              postal_code: $('shipPostal').value,
              state: $('shipState').value,
              city: $('shipCity').value,
              address1: $('shipAddress').value,
              name: $('shipName').value
            }
          }
        };

        const stripe = Stripe(STRIPE_PK);
        const res = await fetch(`${STORE.api}/create_checkout`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload)
        });
        
        const data = await res.json();
        if(data.url) window.location.href = data.url;
        else throw new Error(data.error || "Error iniciando pago");

      } catch (err) {
        alert(err.message);
        els.payBtn.innerText = "IR A PAGAR";
        els.payBtn.disabled = false;
      }
    });

    // --- UI HELPERS ---
    function openDrawer() { els.drawer.classList.add('active'); els.overlay.classList.add('active'); document.body.classList.add('modalOpen'); }
    function closeAll() { 
      els.drawer.classList.remove('active'); 
      els.modal.classList.remove('active'); 
      els.overlay.classList.remove('active');
      document.body.classList.remove('modalOpen');
    }
    function openModal() { els.modal.classList.add('active'); els.overlay.classList.add('active'); document.body.classList.add('modalOpen'); }
    function showToast(msg) { 
      const t = $('toast'); t.innerText = msg; t.classList.add('show'); 
      setTimeout(() => t.classList.remove('show'), 2000); 
    }

    // Event Listeners Globales
    $('openCart').onclick = openDrawer;
    $('closeDrawer').onclick = closeAll;
    $('closeCatalog').onclick = closeAll;
    $('overlay').onclick = closeAll;
    $('pbBtn').onclick = openDrawer;

    document.body.addEventListener('click', (e) => {
      const trigger = e.target.closest('[data-open="catalog"]');
      if(trigger) loadProducts(trigger.dataset.section);
    });

    // Init & PWA
    (function init(){
      const saved = localStorage.getItem('score_cart');
      if(saved) { state.cart = JSON.parse(saved); updateCartUI(); }
      
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js');
      }
    })();
  </script>
</body>
</html>