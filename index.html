<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>SCORE STORE ‚Äî Official Merchandise</title>
<meta name="description" content="Tienda oficial de merch SCORE. Equipamiento aut√©ntico fabricado en Tijuana por √öNICO UNIFORMES."/>

<link rel="icon" href="/icons-score.svg" type="image/svg+xml"/>
<link rel="apple-touch-icon" href="/assets/icons/icon-192.png"/>
<link rel="manifest" href="/site.webmanifest"/>

<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;600;700&family=Inter:wght@400;500;600;700&family=Teko:wght@400;600;700&display=swap" rel="stylesheet"/>

<link href="/css/styles.css" rel="stylesheet"/>

<link as="image" href="/assets/hero.webp" rel="preload"/>
<link as="fetch" crossorigin="" href="/data/catalog.json" rel="preload"/>

<script async="" defer="" src="https://js.stripe.com/v3/"></script>
</head>

<body>
  <div class="bgWrap">
    <div class="bgImg"></div>
    <div class="bgOverlay"></div>
  </div>

  <header class="topbar">
    <div class="container topbarInner">
      <a class="brand" href="/">
        <img alt="SCORE STORE" class="brandLogo" height="44" src="/assets/logo-score.webp" width="160"/>
      </a>
      <nav class="nav">
        <button class="navBtn" onclick="scrollToId('drops')" type="button">Drops</button>
        <button class="navBtn" onclick="scrollToId('catalog')" type="button">Cat√°logo</button>
        <button class="navBtn cartBtn" id="openCartBtn" onclick="openDrawer()" type="button">
          <span class="cartIcon" aria-hidden="true">üõí</span>
          <span id="cartCount">0</span>
        </button>
      </nav>
    </div>
  </header>

  <main>
    <section class="hero" id="top">
      <div class="container heroInner">
        <div class="heroText">
          <h1>SCORE<br><span style="color:var(--red)">INTERNATIONAL</span></h1>
          <p class="lead">Equipamiento oficial de las carreras m√°s duras del mundo. Fabricado en Tijuana por √öNICO UNIFORMES.</p>
          <div class="heroActions">
            <button class="btn primary" onclick="scrollToId('catalog')" type="button">COMPRAR AHORA</button>
            <button class="btn ghost" onclick="scrollToId('drops')" type="button">VER DROPS</button>
          </div>
          <div class="heroBadges">
            <span class="badge">üí≥ Pagos Seguros</span>
            <span class="badge">üì¶ Env√≠os Nacionales</span>
            <span class="badge">üî• Edici√≥n Limitada</span>
          </div>
        </div>
        
        <div class="heroCard">
          <div class="heroCardTop">
            <div class="heroCardTitle">DROP DESTACADO</div>
            <div class="heroCardTag">LIMITADO</div>
          </div>
          <div class="heroCardBody">
            <div class="heroCardName" id="featuredName">Cargando...</div>
            <div class="heroCardPrice" id="featuredPrice"></div>
            <img id="featuredImg" src="" style="width:100%; height:150px; object-fit:contain; margin:10px 0; mix-blend-mode:lighten; display:none;">
            <div class="heroCardCta">
              <button class="btn primary full" id="featuredBtn" type="button">VER PRODUCTO</button>
            </div>
            <div class="heroCardNote">* Stock sujeto a disponibilidad.</div>
          </div>
        </div>
      </div>
    </section>

    <section class="section" id="drops">
      <div class="container">
        <div class="sectionHead">
          <h2>DROPS <span>EXCLUSIVOS</span></h2>
          <p>Ediciones limitadas y art√≠culos de colecci√≥n Baja 1000.</p>
        </div>
        <div class="grid" id="dropsGrid"></div>
      </div>
    </section>

    <section class="section" id="catalog">
      <div class="container">
        <div class="sectionHead">
          <h2>CAT√ÅLOGO <span>OFICIAL</span></h2>
          <p>Selecciona tu talla y agrega al carrito.</p>
        </div>
        
        <div class="filters">
          <input class="search" id="search" placeholder="Buscar producto..." type="search"/>
          <select class="select" id="filterCat">
            <option value="all">Todas las categor√≠as</option>
          </select>
        </div>
        
        <div class="grid" id="catalogGrid"></div>
      </div>
    </section>

    <section class="section" id="shipping">
      <div class="container">
        <div class="sectionHead">
          <h2>COTIZAR <span>ENV√çO</span></h2>
          <p>Calcula el costo real de env√≠o con Envia.com</p>
        </div>
        <div class="shipBox">
          <div class="shipRow">
            <label class="lbl" for="zip">C√ìDIGO POSTAL (5 D√çGITOS)</label>
            <input class="input" id="zip" inputmode="numeric" maxlength="5" placeholder="Ej. 22000" type="text"/>
          </div>
          <div class="shipRow">
            <button class="btn primary" id="quoteBtn" type="button">CALCULAR</button>
          </div>
          <div class="shipResult" id="shipResult"></div>
        </div>
      </div>
    </section>

    <section class="section partners" id="partners">
      <div class="container">
        <div class="partnersGrid">
          <img alt="√öNICO Uniformes" class="pLogo" src="/assets/logo-unico.webp" style="opacity:1; filter:none;"/>
          <img alt="BFGoodrich" class="pLogo" src="/assets/logo-bfgodrich.webp"/>
          <img alt="Ford" class="pLogo" src="/assets/logo-ford.webp"/>
          <img alt="RZR" class="pLogo" src="/assets/logo-rzr.webp"/>
        </div>
      </div>
    </section>
  </main>

  <div class="overlay" id="overlay" onclick="closeAll()" aria-hidden="true"></div>
  <aside class="drawer" id="drawer" role="dialog">
    <div class="drawerHead">
      <h3 class="dTitle">TU CARRITO</h3>
      <button class="iconBtn" onclick="closeAll()" type="button">‚úï</button>
    </div>
    
    <div class="drawerBody">
      <div class="cartItems" id="cartItems"></div>
      <div class="cartEmpty" id="cartEmpty" style="text-align:center; padding:20px; color:#aaa;">Tu carrito est√° vac√≠o.</div>
    </div>
    
    <div class="drawerFoot">
      <div class="totals">
        <div class="row"><span>Subtotal</span><strong id="subTotal">$0</strong></div>
        <div class="row"><span>Env√≠o</span><strong id="shipTotal">‚Äî</strong></div>
        <div class="row big"><span>TOTAL</span><strong id="grandTotal">$0</strong></div>
      </div>
      <button class="btn primary full" id="checkoutBtn" type="button">PAGAR AHORA</button>
      <div class="smallNote">üîí Pago seguro procesado por Stripe.</div>
    </div>
  </aside>

  <footer class="footer">
    <div class="container footerInner">
      <div class="fCol">
        <div class="fTitle">SCORE STORE</div>
        <p class="fText">Merch oficial fabricado en Tijuana, B.C. por √öNICO UNIFORMES.</p>
        <p class="fText" style="margin-top:10px;">Palermo 6106 Interior JK, Anexa Roma, 22614</p>
        <a href="https://wa.me/526642368701" style="color:#00E676; text-decoration:none; display:block; margin-top:10px;">WhatsApp: 664 236 8701</a>
      </div>
      <div class="fCol">
        <div class="fTitle">LINKS</div>
        <a class="fLink" href="#drops">Drops Limitados</a>
        <a class="fLink" href="#catalog">Cat√°logo Completo</a>
        <a class="fLink" href="/legal.html">T√©rminos y Condiciones</a>
      </div>
    </div>
    <div class="copy">¬© 2025 SCORE STORE ¬∑ Operado por √önico Uniformes</div>
  </footer>

  <div class="toast" id="toast">Listo</div>

  <script>
    const DEBUG = (location.hostname === 'localhost');
    const API_BASE = (location.hostname.includes('netlify')) ? '/.netlify/functions' : '/api';
    const CART_KEY = "score_cart_v3";
    const PROMO_KEY = "score_promo_v3";

    // Estado Global
    let cart = [];
    let catalog = [];
    let shipQuote = null;

    /* ===== HELPERS ===== */
    const $ = (id) => document.getElementById(id);
    const money = (n) => new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"}).format(n||0);
    function scrollToId(id){ const el=$(id); if(el) el.scrollIntoView({behavior:"smooth",block:"start"}); }
    
    function showToast(msg){
      const t = $("toast"); t.textContent = msg; t.classList.add("show");
      setTimeout(()=> t.classList.remove("show"), 2500);
    }

    /* ===== CART LOGIC ===== */
    function loadCart(){ try{ cart = JSON.parse(localStorage.getItem(CART_KEY) || "[]"); } catch(e){ cart=[]; } }
    function saveCart(){ localStorage.setItem(CART_KEY, JSON.stringify(cart)); }
    
    function cartCount(){ return cart.reduce((a,i)=>a + (i.qty||0), 0); }
    function cartSubtotal(){ return cart.reduce((a,i)=>a + (i.price||0)*(i.qty||0), 0); }

    function updateTotals(){
      $("cartCount").textContent = cartCount();
      $("subTotal").textContent = money(cartSubtotal());
      
      const shipCost = shipQuote ? shipQuote.mxn : 0;
      $("shipTotal").textContent = shipQuote ? money(shipCost) : "Cotizar al pagar";
      
      const total = cartSubtotal() + shipCost;
      $("grandTotal").textContent = money(total);
    }

    function renderCart(){
      const wrap = $("cartItems");
      wrap.innerHTML = "";
      $("cartEmpty").style.display = cart.length ? "none" : "block";

      cart.forEach((item, idx)=>{
        const row = document.createElement("div");
        row.className = "cartRow";
        row.innerHTML = `
          <div class="cInfo">
            <div class="cName">${item.name}</div>
            <div class="cMeta">${item.variant || ""}</div>
            <div class="cPrice">${money(item.price)}</div>
          </div>
          <div class="cQty">
            <button class="qtyBtn" data-act="dec" data-idx="${idx}">‚àí</button>
            <span class="qtyNum">${item.qty}</span>
            <button class="qtyBtn" data-act="inc" data-idx="${idx}">+</button>
          </div>
          <button class="iconBtn" data-act="del" data-idx="${idx}" style="margin-left:10px; color:#E10600;">&times;</button>
        `;
        wrap.appendChild(row);
      });

      wrap.querySelectorAll("[data-act]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const idx = Number(btn.getAttribute("data-idx"));
          const act = btn.getAttribute("data-act");
          if(!cart[idx]) return;
          if(act==="inc") cart[idx].qty++;
          if(act==="dec") cart[idx].qty = Math.max(1, cart[idx].qty-1);
          if(act==="del") cart.splice(idx,1);
          saveCart(); renderCart(); updateTotals();
        });
      });
    }

    /* ===== CATALOG LOGIC ===== */
    function renderCatalog(){
      const grid = $("catalogGrid");
      grid.innerHTML = "";
      
      const q = ($("search").value||"").toLowerCase().trim();
      const cat = $("filterCat").value;

      const filtered = catalog.filter(p => {
        if(q && !p.name.toLowerCase().includes(q)) return false;
        if(cat !== "all" && p.category !== cat) return false;
        return true;
      });

      filtered.forEach(p => {
        const card = createProductCard(p);
        grid.appendChild(card);
      });
    }

    function renderDrops(){
      const grid = $("dropsGrid");
      // Productos marcados como "limited" o "drop" en el JSON
      const drops = catalog.filter(p => p.tags && (p.tags.includes('limited') || p.tags.includes('drop')));
      if(!drops.length) return; // Ocultar secci√≥n si no hay drops
      
      drops.forEach(p => {
        const card = createProductCard(p);
        grid.appendChild(card);
      });
    }

    function createProductCard(p){
      const card = document.createElement("div");
      card.className = "card prodCard";
      const img = p.img || "/assets/logo-score.webp";
      const sizes = p.sizes || ["Unitalla"];
      
      // Select HTML
      const options = sizes.map(s => `<option value="${s}">${s}</option>`).join("");

      card.innerHTML = `
        <div class="prodImg">
          <img src="${img}" alt="${p.name}" loading="lazy">
        </div>
        <div class="prodBody">
          <div class="prodTop">
            <div class="prodName">${p.name}</div>
            <div class="prodPrice">${money(p.baseMXN)}</div>
          </div>
          <div class="prodMeta">${p.sectionId || "Oficial"}</div>
          <div class="prodActions">
            <select class="select sizePick">
              ${options}
            </select>
            <button class="btn primary addBtn">AGREGAR</button>
          </div>
        </div>
      `;
      
      card.querySelector(".addBtn").addEventListener("click", () => {
        const s = card.querySelector(".sizePick").value;
        const key = `${p.id}_${s}`;
        const exist = cart.find(i => i.key === key);
        
        if(exist) exist.qty++;
        else cart.push({ key, id:p.id, name:p.name, variant:`Talla: ${s}`, price:p.baseMXN, qty:1 });
        
        saveCart(); updateTotals(); renderCart(); openDrawer(); showToast("Agregado al carrito");
      });
      return card;
    }

    function setFeatured(){
      // El producto destacado es el primero marcado como "featured"
      const p = catalog.find(x => x.tags && x.tags.includes('featured')) || catalog[0];
      if(!p) return;
      
      $("featuredName").textContent = p.name;
      $("featuredPrice").textContent = money(p.baseMXN);
      // Mostrar imagen si se desea
      const img = $("featuredImg");
      img.src = p.img;
      img.style.display = "block";
      
      $("featuredBtn").onclick = () => scrollToId("catalog");
    }

    /* ===== SHIPPING QUOTE (Envia.com via Server) ===== */
    async function quoteShipping(){
      const zip = $("zip").value.trim();
      if(zip.length !== 5) { showToast("C√≥digo postal inv√°lido"); return; }
      
      $("shipResult").innerHTML = "Calculando...";
      
      try {
        const res = await fetch(`${API_BASE}/quote_shipping`, {
          method: "POST", headers:{"Content-Type":"application/json"},
          body: JSON.stringify({ postal_code: zip, items: 1 })
        });
        const data = await res.json();
        
        if(data.ok) {
          shipQuote = data;
          $("shipResult").innerHTML = `<span style="color:#fff">${data.label}</span>: <strong>${money(data.mxn)}</strong>`;
        } else {
          $("shipResult").innerText = "Env√≠o Nacional Est√°ndar: $250.00";
          shipQuote = { mxn: 250 }; // Fallback
        }
      } catch(e) {
        $("shipResult").innerText = "Error cotizando. Se aplicar√° tarifa est√°ndar.";
      }
    }
    $("quoteBtn").addEventListener("click", quoteShipping);

    /* ===== CHECKOUT (Stripe) ===== */
    async function checkout(){
      if(!cart.length) { showToast("Carrito vac√≠o"); return; }
      const btn = $("checkoutBtn");
      btn.disabled = true; btn.textContent = "PROCESANDO...";
      
      try {
        const res = await fetch(`${API_BASE}/create_checkout`, {
          method: "POST", headers:{"Content-Type":"application/json"},
          body: JSON.stringify({ items: cart, mode: "mx" })
        });
        const data = await res.json();
        if(data.url) location.href = data.url; else throw new Error("Error iniciando pago");
      } catch(e) {
        showToast("Error de conexi√≥n");
        btn.disabled = false; btn.textContent = "PAGAR AHORA";
      }
    }
    $("checkoutBtn").addEventListener("click", checkout);

    /* ===== DRAWER ===== */
    function openDrawer(){ $("drawer").classList.add("open"); $("overlay").classList.add("open"); document.body.classList.add("lock"); }
    function closeAll(){ 
      document.querySelectorAll(".open").forEach(e=>e.classList.remove("open")); 
      document.body.classList.remove("lock"); 
    }

    /* ===== INIT ===== */
    async function init(){
      loadCart(); updateTotals(); renderCart();
      
      try {
        const res = await fetch("/data/catalog.json");
        const data = await res.json();
        catalog = data.products || [];
        
        // Populate Filters
        const cats = new Set();
        catalog.forEach(p => { if(p.category) cats.add(p.category); });
        const sel = $("filterCat");
        cats.forEach(c => {
           const o = document.createElement("option"); o.value = c; o.text = c;
           sel.appendChild(o);
        });
        
        renderCatalog();
        renderDrops();
        setFeatured();
      } catch(e) { console.error("Error loading catalog"); }
      
      // Listeners
      $("search").addEventListener("input", renderCatalog);
      $("filterCat").addEventListener("change", renderCatalog);
    }

    init();
    if ("serviceWorker" in navigator) navigator.serviceWorker.register("/sw.js");
  </script>
</body>
</html>
